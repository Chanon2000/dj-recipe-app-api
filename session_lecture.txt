[136. Deployment plan]

Various ways to deploy Django
    - Directly on a server
        -Run directly on server เลยโดยอาจใช้เช่น Nginx
        -รันผ่าน Docker ใน server (ซึ่งคุณก็สามารถใช้แค่ Docker-compose เพื่อรัน app แบบง่ายๆ)

    - ใช้ serverless Cloud
        # โดย upload application ไปที่ service โดยเราแค่ publish code ของเราบน service แล้วเรื่องของ hardware มันจะจัดการให้เราเอง
        ยกตัวอย่างเช่น Google Cloud Run / Google App Engine
        AWS Elastic Beanstalk / ECS Fargate

How we'll deploy
    - เราจะใช้ Single VPS on AWS (หรือก็คือ EC2)
        VPS = Virtual private server
        คือ Virtual private server หรือก็คือ virtual machine ที่เราจะซื้อจาก aws
    - และเราจะใช้ docker / docker compose เพื่อรัน application บน server นั้น
        # เราจะมี EC2 1 instance และ เราจะรัน Docker service บน instance และมันก็จะสามารถเข้าถึงได้จาก outside website แล้ว user ก็จะสร้าง connect เข้ามาได้

Steps we'll take
    1. Configure project for deployment
    2. Create server on AWS
    3. Deploy app


video: The 4 best ways to deploy a Django application
https://www.youtube.com/watch?v=IoxHUrbiqUo

[137. Django deployment overview]

สิ่งที่เราต้องทำเมื่อทำการ Deploying Django
    1. Setup a proxy
    2. Handle static / media files
    3. Configuration app ของเราบน server


Components ต่างๆสำหรับการ Deployment
    - Persistent Data
        # เมื่อ upload files มันไม่ควรเก็บลง container แต่ควรเก็บลงที่นี้ หรือ persistent volume
        # ซึ่ง volume สามารถเข้าได้โดย containers ต่างๆที่อยู่ใน service
    - WSGI (Django)
        # WSGI => Web server gateway interface
        # whiskey service
    - Users

    - Reverse Proxy
        # คือที่ที่จะ accept request เข้า application
        # นั้นคือทุก request ที่มาจาก internet มันจะไม่ตรงไปที่ Django service (หรือ whiskey service) แต่จะเข้าตรงนี้หรือproxyก่อน
        Why use a reverse proxy?
            - Best practice when deploying Django
            - whiskey server ที่รัน python (หรือ web server gateway interface) มันไม่เหมาะกับการจัดการ requests เยอะๆ และมันสามารถ serve พวก images css js static files ได้และไม่มีประสิทธิภาพเลย
                # whiskey server Not great at serving data
            - Web servers นั้นมีประสิทธิภาพมาก ให้การ serve static files และจัดการ requests แบบเยอะๆ
            (เราจะ setup reverse proxy ให้ใช้ web server application เพื่อให้เราสามารถ serve files ที่ web server หรือ reverse proxy นั้นแหละ มีประสิทธิภาพในการ serve ผ่าน proxy)

        Application ที่เราจะใช้
            - nginx => คือ web server ซึ่ง open source, fast, secure, production grade, very popular tool และเป็น tool ที่นิยมมากในการสร้าง reverse proxy or web server
            - uWSGI => Whiskey server หรือ Web server gateway interface
            - Docker Compose
                # เพื่อเอาแต่ละอย่างมารวมกัน แล้ว serve มันใน server

Docker Compose setup มีอะไรบ้างดังนี้
    - app uWSGI (เพื่อ serve app ของเรา)
        # ถ้า request เป็น static/media files จะไม่เข้าที่นี้แต่จะไปเข้าที่ proxy
        # แต่ถา request ไม่ใช้ static/media files มันถึงจะมาเข้าที่ proxy และมาที่ Django ต่อ
    - db
    - proxy (nginx) รับ request/response
        # จะ serve static/media file เลยโดยไม่ผ่าน django (จะตรงๆเข้า volumn ผ่าน proxy แล้ว django app จะไม่รู้ด้วยซำ้ว่ามี request นี้)
    - volume
        -static data (static/media)
        -prostgres-data (data จาก database)
            # เราเก็บ data ไว้ตรงนี้ทำให้ถึงแม้ว่า server จะ reboot นั้น data เราก็จะไม่หาย

Handling configuration
    - เราจะ configure deployed app อย่างไร?
        -อย่างใส่ทุกอย่างลง Git (เพื่อ key, secret, password ต่างๆ)
    - Various approaches (วิธีต่างๆในการจัดการ configure พวกนี้)
        -Environment variables (เราจะใช้วิธีนี้)
            # ซึ่งก็เป็นวิธีที่เราใช้ใน docker compose อยู่แล้ว
        -Secret managers
            # ซึ่งก็มีให้บริการในทุก cloud เช่น aws, google cloud แต่เราต้องเอา app ของเราไป deploy ที่ cloud นั้นๆ

How configuration works
    - Create .env file on server
    - Set values in Docker Compose

Using AWS
    - We'll host our app on AWS
        # Popular platform
    - Students responsible for security and costs
    - Must keep your account secure!
        -Use MFA (multi-factor authentication เพื่อให้ account secure มากขึ้น)
        -Use strong passwords
        -Don't share your account details
        -Keep your machine secure and update to date
        -Delete unused accounts (ถ้าไม่ใช้แล้วควรลบทิ้ง เพื่อกันไม่ให้ใครเอาไปใช้)

[138. Add uWSGI to project]

เมื่อ setup ทุกอย่างเสร็จลอง build image ดูว่ามันจะมีปัญหาอะไรมั้ย
'docker-compose build'

uWSGI: https://pypi.org/project/uWSGI/

[139. Create proxy configs]

สร้าง proxy configuration และ Dockerfile

default.conf.tpl => Default.configuration.template
จะเป็น file ที่เก็บ value บางอย่างเอาไว้ เพื่อเมื่อรัน proxy (nginx คือที่เราจะใช้) จริงๆ เราจะเอา file นี้เข้าไปใส่ในบางสิ่งเพื่อให้มันรัน ไม่ได้เอา file นี้ไม่รันตรงๆ

configuration ของ nginx ต้องการ ; ที่ จุดสิ้นสุดของแต่ละบรรทัด

# เป็น configuration block
server {
    # แต่ละ block นี้จะ executed เป็น order จากบนลงล่าง
    listen ${LISTEN_PORT};
    # port ที่ server จะ listen on
    # แล้วผ่านเข้าไปใน service
    # ใส่เป็น variable (LISTEN_PORT) ซึ่งเดี๋ยวต้องเอา var พวกนี้ใส่เข้า project ด้วย

    # location block เอาไว้ map url ที่ผ่านเข้ามาใน server
    location /static { # บอกว่า url ใหนที่เริ่มจาก /static มันจะไปที่ alias /vol/static ซึ่งก็คือ volume ที่เก็บ static และ media files ของ app เรา
        alias /vol/static;
    }

    # block location นี้เอาไว้จัดการ requests ที่เหลือที่ไม่เจอ location block ด้านบน
    # ให้แต่ละ key กับ value อยู่ในระดับเดียวกัน เลยเว้นวรรคแบบนั้น
    location / {
        uwsgi_pass              ${APP_HOST}:${APP_PORT}; # เช่น localhost:8000 เป็นต้น ซึ่งต้องเป็นที่ที่ whiskey server รันอยู่ (และเราต้อง configure nginx server ให้สามารถ connect กับ service นี้ได้)
        include                 /etc/nginx/uwsgi_params;
        # ต้อง include whiskey params คือ parameters ที่จำเป็นสำหรับ http request เพื่อ process ใน whiskey (ซึ่งเดี๋ยวเราต้อง configurate มันต่อ โดยหลักๆก็คือ list ของ parameters ที่จะใส่ลง http request มาที่ running service)
        client_max_body_size    10M; # คือกำหนดขนาด maximum body size of the request ที่จะผ่านเข้ามา # เช่น maximum image ที่เราจะสามารถ upload ได้คือ 10M
    }
}

ต่อมาสร้าง uwsgi_params file ซึ่งมันมี doc สำหรับ param ที่เรากำหนดให้
docs: https://uwsgi-docs.readthedocs.io/en/latest/Nginx.html#what-is-the-uwsgi-params-file

เรา copy มาวางเลยไม่ต้องคิดอะไรเยอะ (ค่อยศึกษาที่หลัง)

จากนั้นก็สร้าง run.sh เพื่อ start proxy service ของเรา

[40. Create proxy Dockerfile]

เมื่อ config เสร็จก็ลองทดสอบ build โดยการ
    "cd proxy"
    "docker build ."


[141. Handling configuration]

เราจะใช้ environment variables เพื่อจัดการรัน app
    - Store configuration in a file
    - Retrieve values with Docker Compose
    - Pass to applications

เราจะสร้าง .env เพื่อเก็บ variable ต่างๆ แล้วเอา var มาใส่ใน docker-compose file และก็สามารถเอาไปกำหนดใน python code ได้เช่นกัน

[142. Create docker compose config]

.env.sample
เพื่อสร้าง template env ที่สามารถใช้บน server ได้ และเมื่อเราจะ deploy เราก็แค่ re-name file นี้เป็น
.env

[143. Update Django settings]

เราจะมาแก้ไข setting.py file เพื่อให้มันใช้ configured environment variables

สร้าง .env ขึ้นมา โดย file นี้จะเก็บ secret จริงๆ (ซึ่ง file นี้ จะ auto ถูก ignore โดย git)
และเป็น file ที่จะset ตัวแปรต่างๆเพื่อใช้ใน configuration สำหรับ deployed application

ส่วน .env.sample นั้นแค่เอามาเก็บไว้เฉยๆ จะได้ไม่ลืม

เพื่อทดสอบ deployment environment ก่อนเราจะไป deploy จริงๆที่ server

เพื่อ clear container ที่มีออกก่อน
'docker-compose -f docker-compose-deploy.yml down'

เพื่อ start server แบบ deployment environment
'docker-compose -f docker-compose-deploy.yml up'

จากนั้นลองไปที่ http://127.0.0.1:8000/api/docs/ จะเห็น app ของเรารันอยู่ นั้นแปลว่า deployment environment รันได้ไม่มีปัญหาอะไร

(อย่าลืมเปลี่ยน port กลับเป็น 80 ที่ docker-compose-deploy.yml ด้วย)

[144. Creating a virtual server]

สิ่งที่เราจะทำต่อไปคือ
    - Create AWS account and user
    - Login to console
    - Create new virual server

AWS Costs => calcuator.aws (เพื่อคำนวณราคาที่เราจะต้องจ่าย)

หลังจากสร้าง server แล้ว

Connecting to the server
    - Connect via SSH (บน terminal)
    - Use same SSH key as for GitHub

[145. Create AWS account and user]

เมื่อสร้าง root user account สำเร็จ แนะนำว่าไม่ควรใช้ root user account ในการ login ในแต่ละวัน เพราะมันมี privileges มาก ดังนั้นคุณต้องสร้าง admin account อีกอันนึงเพื่อในในแต่ละวัน เพื่อให้ root account ปลอดภัย

นั้นคือเราต้องสร้าง IAM user
IAM: https://us-east-1.console.aws.amazon.com/iamv2/home?region=us-east-1#/home

ไปที่ IAM dashbaord -> ไปที่ Users menu -> Add users -> ติ๊กที่ Password - AWS Management Console access -> เลือกCustom password ต่อ -> ใส่รหัสที่ต้องการ -> คลิก Next -> ไปที่ Attach existing policies directory -> แล้วติ๊กที่ AdministratorAccess (ซึ่งจะทำให้ user คนที่เราสร้างอยู่นี้สามารถเข้าถึงทุกอย่างใน root account เราได้ ยกเว้นลบ root account) -> Next -> Next -> Create user

IAM user ที่เป็น administrative
mick
mick@18791955

